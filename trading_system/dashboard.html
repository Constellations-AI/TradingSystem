<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading System Monitor</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #4CAF50;
        }
        .card.warning { border-left-color: #ff9800; }
        .card.error { border-left-color: #f44336; }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        .metric-value {
            font-weight: bold;
            color: #4CAF50;
        }
        .metric-value.negative { color: #f44336; }
        .trader-section {
            margin: 30px 0;
        }
        .trader-card {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        .trader-card.active { border-left-color: #4CAF50; }
        .trader-card.inactive { border-left-color: #757575; }
        .trade-log {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .trade-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        .trade-buy { color: #4CAF50; }
        .trade-sell { color: #f44336; }
        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .refresh-btn:hover { background: #45a049; }
        .auto-refresh {
            margin: 20px 0;
            text-align: center;
        }
        .timestamp {
            color: #888;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            color: #888;
            padding: 20px;
        }
        .error-message {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Trading System Monitor</h1>
        <p class="timestamp" id="lastUpdate">Loading...</p>
        <div class="auto-refresh">
            <button class="refresh-btn" onclick="refreshAll()">üîÑ Refresh Now</button>
            <button class="refresh-btn" id="autoRefreshBtn" onclick="toggleAutoRefresh()">‚ñ∂Ô∏è Start Auto-Refresh</button>
        </div>
    </div>

    <div id="errorContainer"></div>

    <div class="status-grid">
        <div class="card" id="systemCard">
            <h3>üìä System Overview</h3>
            <div class="loading" id="systemLoading">Loading...</div>
            <div id="systemMetrics" style="display: none;"></div>
        </div>
        
        <div class="card" id="healthCard">
            <h3>üè• System Health</h3>
            <div class="loading" id="healthLoading">Loading...</div>
            <div id="healthStatus" style="display: none;"></div>
        </div>
    </div>

    <div class="trader-section">
        <h2>üë• Trader Performance</h2>
        <div id="traderContainer">
            <div class="loading">Loading trader data...</div>
        </div>
    </div>

    <div class="trader-section">
        <h2>üìà Recent Activity</h2>
        <div class="trade-log" id="activityLog">
            <div class="loading">Loading recent activity...</div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefreshing = false;

        // API base URL - will try to detect automatically
        let API_BASE = window.location.origin;
        if (window.location.pathname.includes('.html')) {
            // If served as static file, try localhost
            API_BASE = 'http://localhost:8000';
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
        }

        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                throw error;
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatPercent(value) {
            return `${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
        }

        async function loadSystemMetrics() {
            try {
                const data = await fetchAPI('/api/system/performance');
                const container = document.getElementById('systemMetrics');
                const loading = document.getElementById('systemLoading');
                
                const metrics = data.system_metrics;
                container.innerHTML = `
                    <div class="metric">
                        <span>Database:</span>
                        <span>${data.database_type}</span>
                    </div>
                    <div class="metric">
                        <span>Active Traders:</span>
                        <span>${metrics.active_traders_today}/${metrics.total_traders}</span>
                    </div>
                    <div class="metric">
                        <span>Total Portfolio:</span>
                        <span class="metric-value">${formatCurrency(metrics.total_portfolio_value)}</span>
                    </div>
                    <div class="metric">
                        <span>Total P&L:</span>
                        <span class="metric-value ${metrics.total_pnl < 0 ? 'negative' : ''}">${formatCurrency(metrics.total_pnl)}</span>
                    </div>
                    <div class="metric">
                        <span>Trades Today:</span>
                        <span>${metrics.total_trades_today}</span>
                    </div>
                `;
                
                loading.style.display = 'none';
                container.style.display = 'block';
                
                // Update system card color based on P&L
                const systemCard = document.getElementById('systemCard');
                systemCard.className = metrics.total_pnl < -100 ? 'card error' : 
                                     metrics.total_pnl < 0 ? 'card warning' : 'card';
                
            } catch (error) {
                document.getElementById('systemLoading').innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        async function loadHealthStatus() {
            try {
                const data = await fetchAPI('/api/system/health');
                const container = document.getElementById('healthStatus');
                const loading = document.getElementById('healthLoading');
                
                const statusEmoji = {
                    'healthy': 'üü¢',
                    'degraded': 'üü°', 
                    'error': 'üî¥'
                };
                
                container.innerHTML = `
                    <div class="metric">
                        <span>Status:</span>
                        <span>${statusEmoji[data.status] || '‚ùì'} ${data.status.toUpperCase()}</span>
                    </div>
                    <div class="metric">
                        <span>Database:</span>
                        <span>${data.database.connection_test === 'success' ? '‚úÖ' : '‚ùå'} ${data.database.type}</span>
                    </div>
                    ${data.system ? `
                    <div class="metric">
                        <span>CPU:</span>
                        <span>${data.system.cpu_percent.toFixed(1)}%</span>
                    </div>
                    <div class="metric">
                        <span>Memory:</span>
                        <span>${data.system.memory_percent.toFixed(1)}%</span>
                    </div>
                    ` : ''}
                `;
                
                loading.style.display = 'none';
                container.style.display = 'block';
                
                // Update health card color
                const healthCard = document.getElementById('healthCard');
                healthCard.className = data.status === 'healthy' ? 'card' :
                                     data.status === 'degraded' ? 'card warning' : 'card error';
                
            } catch (error) {
                document.getElementById('healthLoading').innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        async function loadTraderData() {
            try {
                const data = await fetchAPI('/api/system/performance');
                const container = document.getElementById('traderContainer');
                
                let html = '';
                Object.entries(data.traders).forEach(([name, trader]) => {
                    if (trader.error) {
                        html += `
                            <div class="trader-card error">
                                <h4>‚ùå ${name.toUpperCase()}</h4>
                                <p>Error: ${trader.error}</p>
                            </div>`;
                        return;
                    }
                    
                    const statusClass = trader.is_active_today ? 'active' : 'inactive';
                    const statusEmoji = trader.is_active_today ? 'üü¢' : 'üî¥';
                    
                    html += `
                        <div class="trader-card ${statusClass}">
                            <h4>${statusEmoji} ${name.toUpperCase()}</h4>
                            <div class="metric">
                                <span>Portfolio Value:</span>
                                <span class="metric-value">${formatCurrency(trader.portfolio_value)}</span>
                            </div>
                            <div class="metric">
                                <span>Cash Balance:</span>
                                <span>${formatCurrency(trader.cash_balance)}</span>
                            </div>
                            <div class="metric">
                                <span>P&L:</span>
                                <span class="metric-value ${trader.pnl < 0 ? 'negative' : ''}">${formatCurrency(trader.pnl)} (${formatPercent(trader.pnl_percent)})</span>
                            </div>
                            <div class="metric">
                                <span>Holdings:</span>
                                <span>${Object.keys(trader.holdings).length} symbols</span>
                            </div>
                            <div class="metric">
                                <span>Trades Today:</span>
                                <span>${trader.trades_today}</span>
                            </div>
                            ${trader.last_trade ? `
                            <div class="metric">
                                <span>Last Trade:</span>
                                <span class="${trader.last_trade.side === 'BUY' ? 'trade-buy' : 'trade-sell'}">${trader.last_trade.side} ${trader.last_trade.quantity} ${trader.last_trade.symbol}</span>
                            </div>
                            ` : ''}
                        </div>`;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                document.getElementById('traderContainer').innerHTML = `<div class="error-message">Error loading trader data: ${error.message}</div>`;
            }
        }

        async function loadRecentActivity() {
            try {
                const data = await fetchAPI('/api/system/live-activity');
                const container = document.getElementById('activityLog');
                
                let html = '';
                
                // Recent trades
                if (data.recent_trades && data.recent_trades.length > 0) {
                    html += '<h4>üí∏ Recent Trades:</h4>';
                    data.recent_trades.slice(0, 20).forEach(trade => {
                        const tradeClass = trade.side === 'BUY' ? 'trade-buy' : 'trade-sell';
                        html += `
                            <div class="trade-entry ${tradeClass}">
                                ${trade.timestamp} - ${trade.trader.toUpperCase()}: ${trade.side} ${trade.quantity} ${trade.symbol} @ ${formatCurrency(trade.price)}
                            </div>`;
                    });
                } else {
                    html += '<p>No recent trades in the last 30 minutes.</p>';
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                document.getElementById('activityLog').innerHTML = `<div class="error-message">Error loading activity: ${error.message}</div>`;
            }
        }

        function updateTimestamp() {
            document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleString()}`;
        }

        async function refreshAll() {
            document.getElementById('errorContainer').innerHTML = '';
            updateTimestamp();
            
            try {
                await Promise.all([
                    loadSystemMetrics(),
                    loadHealthStatus(),
                    loadTraderData(),
                    loadRecentActivity()
                ]);
            } catch (error) {
                showError(`Failed to refresh data: ${error.message}`);
            }
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (isAutoRefreshing) {
                clearInterval(autoRefreshInterval);
                btn.textContent = '‚ñ∂Ô∏è Start Auto-Refresh';
                btn.style.background = '#4CAF50';
                isAutoRefreshing = false;
            } else {
                autoRefreshInterval = setInterval(refreshAll, 10000); // 10 seconds
                btn.textContent = '‚è∏Ô∏è Stop Auto-Refresh';
                btn.style.background = '#ff9800';
                isAutoRefreshing = true;
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            refreshAll();
        });
    </script>
</body>
</html>